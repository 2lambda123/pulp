var SearchApp=angular.module("SearchApp",["ngRoute","angular-bootstrap-select"]);SearchApp.config(function($routeProvider){$routeProvider.when("/",{controller:"SearchController",templateUrl:"static/js/app/views/search.html"}).when("/settings",{controller:"SettingsController",templateUrl:"static/js/app/views/settings.html"}).otherwise({redirectTo:"/"})}),SearchApp.run(function($rootScope){$rootScope.settings={participant_id:"",task_type:0,exploration_rate:0,query_time:15}}),SearchApp.filter("strip_tags",function(){return function(text){return String(text).replace(/<[^>]+>/gm,"")}}),SearchApp.filter("synopsis",function(){return function(text){return String(text).length>300?String(text).substring(0,300)+"...":String(text)}});var UI=function(){var highlight_colors=[{name:"Green",rgb:"74,201,112"},{name:"Orange",rgb:"233,137,49"},{name:"Red",rgb:"235,64,59"},{name:"Turquoise",rgb:"42,176,197"},{name:"Blue",rgb:"34,127,176"}],back_to_top=function(){return $("html, body").scrollTop(0),!1},search_state=function(callback){$(".mean-bar").fadeOut(300),$(".bookmark-history-display").hide(),$("#search-results").fadeOut(300,function(){$("#search-form-container").slideDown(),$("#search-form-container input[type='text']").focus(),callback()})},end_search_state=function(){$("#search-form-container").slideUp(),back_to_top()},loading_state=function(callback){$(".layer").fadeIn(300),$("body").css("cursor","wait"),$("#search-results").fadeOut(300,function(){callback()})},end_loading_state=function(){$(".bookmark-history-display").hide(),$(".layer").fadeOut(300),$("body").css("cursor","default"),$("#search-results").fadeIn(300)},display_mean_and_variance=function(){$(".mean-bar").fadeIn(300),$.each($(".mean-bar .progress-bar"),function(i,el){width=parseFloat($(el).attr("data-mean"))/(parseFloat($(el).attr("data-mean"))+parseFloat(parseFloat($(el).attr("data-variance")))),anim={width:100*width+"%"},$(el).animate(anim,2500,"easeOutCubic"),$(el).parent().tooltip({title:Math.round(100*width)+"% based on previous selections, "+Math.round(100*(1-width))+"% variation"})})},un_highlight=function(text){return String(text).replace(/<[^>]+>/gm,"")},highlight=function(text,keywords,color){for(var content_words=String(text).split(" "),i=0;i<content_words.length;i++)keywords[content_words[i].toLowerCase()]&&(weight=keywords[content_words[i].toLowerCase()],description="",description=weight<.3?"Light weighted keyword":weight>=.3&&weight<.7?"Medium weighted keyword":"Heavy weighted keyword",content_words[i]="<span class='word-weight animated bounceIn' data-toggle='tooltip' data-placement='top' title='"+description+"' style='background-color: rgba("+color+","+weight+"); border-bottom: 1px solid rgb("+color+")'>"+content_words[i]+"</span>");return content_words.join(" ")};return{search_state:search_state,end_search_state:end_search_state,loading_state:loading_state,end_loading_state:end_loading_state,highlight:highlight,un_highlight:un_highlight,highlight_colors:highlight_colors,back_to_top:back_to_top,display_mean_and_variance:display_mean_and_variance}}();$(document).on("ready",function(){UI.search_state(function(){}),$("#back-to-top").on("click",function(){UI.back_to_top()}),$("body").tooltip({selector:"#results-container .bookmark, .bookmarked-results-container .bookmark, .ellipsis, .bookmark-info, .word-weight"}),$(".bookmark-info").live("mouseenter",function(){$(this).stop().animate({bottom:15},300)}),$(".bookmark-info").live("mouseleave",function(){$(this).stop().animate({bottom:0},300,"easeOutCubic")}),$(".bookmark-history-display-trigger").live("click",function(e){e.preventDefault(),$(".history-articles .bookmark").popover({trigger:"manual",html:!0}).on("mouseenter",function(){var _this=this;$(this).popover("show"),$(".popover").on("mouseleave",function(){$(_this).popover("hide")})}).on("mouseleave",function(){var _this=this;$(".popover:hover").length||$(_this).popover("hide"),setTimeout(function(){},100)})}),$("#article-count").selectpicker(),$("#highlight-color").selectpicker(),$("#back-to-top").removeAttr("disabled"),$("#explain-search-results-modal").draggable(),$(".color-palet-divider").tooltip()}),$(document).on("scroll",function(){var scrollAmount=$(window).scrollTop(),documentHeight=$(document).height(),scrollPercent=scrollAmount/documentHeight*100;scrollPercent>0?$("#back-to-top").animate({bottom:0},400):$("#back-to-top").clearQueue().animate({bottom:-45},400)}),SearchApp.directive("exploitation",function(){return{link:function(scope,elem,attrs){var width=scope.result.mean/(scope.result.mean+scope.result.variance)*100;$(elem).css("width",width+"%"),$(elem).parent().tooltip({title:Math.round(width)+"% based on previous selections, "+Math.round(100-width)+"% variation"})}}}),SearchApp.directive("result",function(){return{link:function(scope,elem,attrs){$(window).on("scroll",function(){var $elem=$(elem),$window=$(window),docViewTop=$window.scrollTop(),docViewBottom=docViewTop+$window.height(),elemTop=$elem.offset().top,elemBottom=elemTop+$elem.height();!scope.result.seen&&docViewBottom>=elemBottom&&elemTop>=docViewTop&&(scope.result.seen=!0)}),$(window).trigger("scroll")}}}),SearchApp.service("Api",function($http){this.next=function(options){var params={selected:_.chain(options.results).where({bookmarked:!0}).map(function(bookmark){return bookmark.id}).value(),participant_id:options.participant_id,clicked:_.chain(options.results).where({clicked:!0}).map(function(clicked){return{id:clicked.id,reading_started:clicked.reading_started.getTime()/1e3,reading_ended:clicked.reading_ended.getTime()/1e3}}).value()};return(0==options.exploratory||1==options.exploratory)&&(params.exploratory=options.exploratory),$http.post("/next",params)},this.search=function(options){return $http.get("/query",{params:{q:options.keyword,"article-count":options.count,participant_id:options.participant_id}})},this.setup=function(options){return $http.get("/setup",{params:{participant_id:options.participant_id,task_type:options.task_type,exploration_rate:options.exploration_rate}})},this.end=function(options){return $http.get("/end",{params:{participant_id:options.participant_id}})}}),SearchApp.service("Classifier",function(){this.is_exploratory=function(options){{var query_length=options.query_length,reading_time=options.reading_time,cumulative_clicks=options.clicks_count;options.seen_count,options.query_duration}return Exploratory=!0,5>=query_length?131>=reading_time?0>=cumulative_clicks?Exploratory=!0:cumulative_clicks>0&&(Exploratory=!1):reading_time>131&&(3>=query_length?Exploratory=!0:query_length>3&&(2>=cumulative_clicks?Exploratory=!0:cumulative_clicks>2&&(Exploratory=!1))):query_length>5&&(Exploratory=!1),Exploratory}}),SearchApp.controller("SearchController",["$scope","$rootScope","$sce","$location","$interval","Api","Classifier",function($scope,$rootScope,$sce,$location,$interval,Api,Classifier){if($scope.seconds_left=0,$rootScope.settings&&$rootScope.settings.participant_id){if($rootScope.settings.query_time){$scope.seconds_left=60*parseInt($scope.settings.query_time);var query_timer=$interval(function(){$scope.seconds_left--,0==$scope.seconds_left&&($interval.cancel(query_timer),Api.end({participant_id:$rootScope.settings.participant_id}).success(function(){alert("The query has ended! Thanks for participating!"),$location.path("/settings")}))},1e3)}}else $location.path("/settings");$scope.chosen_highlight_color_index=0,$scope.result_count=20,$scope.bookmark_history=[],$scope.results=[],$scope.highlight_colors=UI.highlight_colors,$scope.selected_highlight_color=UI.highlight_colors[0],$scope.iteration=1;var first_iteration_started=null,keywords={};$scope.search=function(){reset_variables(),$scope.searching=!0,$scope.loading=!0,Api.search({keyword:$scope.search_keyword,count:parseInt($scope.result_count),participant_id:$rootScope.settings.participant_id}).success(function(response){$scope.results=response,$scope.search_heading=$scope.search_keyword,$scope.loading=!1,init_results(),first_iteration_started=new Date}).error(function(){$scope.search_heading=$scope.search_keyword,$scope.loading=!1,$scope.results=[]})},$scope.toggle_bookmark_history=function(){$scope.bookmark_history_showing=!$scope.bookmark_history_showing},$scope.touch_article=function(article){article.clicked=!0,article.reading_started=new Date,$scope.viewed_article=article},$scope.close_article_view=function(){var now=new Date,start=$scope.viewed_article.reading_started,diff=(now.getTime()-start.getTime())/1e3;$scope.viewed_article.reading_ended=now,$scope.viewed_article.reading_time=diff,$scope.viewed_article=null},$scope.toggle_bookmark=function(result){result.bookmarked=!result.bookmarked},$scope.next=function(){var options={results:$scope.results,participant_id:$rootScope.settings.participant_id};1==$scope.iteration&&(options.exploratory=is_exploratory()?1:0),UI.back_to_top(),$scope.bookmark_history_showing=!1;var history_obj={iteration:$scope.iteration,articles:_.where($scope.results,{bookmarked:!0})};0!=history_obj.articles.length&&$scope.bookmark_history.push(history_obj),$scope.loading=!0,Api.next(options).success(function(response){$scope.results=response.articles,keywords=response.keywords,init_results(),$scope.iteration++,$scope.search_heading=$scope.search_keyword,$scope.highlight_keywords&&highlight(),$scope.loading=!1}).error(function(){$scope.results=[],$scope.loading=!1})},$scope.back_to_top=function(){UI.back_to_top()},$scope.next_is_disabled=function(){return $scope.iteration>1||_.where($scope.results,{bookmarked:!0}).length>0?!1:!0},$scope.end=function(){confirm("Are you sure you wan't to end this query?")&&($interval.cancel(query_timer),$scope.search_keyword="",$scope.loading=!0,Api.end({participant_id:$rootScope.settings.participant_id}).success(function(){$scope.searching=!1,$scope.loading=!1,$location.path("/settings")}))},$scope.toggle_highlight=function(){$scope.highlight_keywords=!$scope.highlight_keywords,$scope.highlight_keywords?highlight():un_highlight()},$scope.show_full_abstract=function(result){result.abstract_synopsis=result["abstract"],result.full_length_abstract=!0},$scope.bookmarked_results=function(result){return 1==result.bookmarked};var un_highlight=function(){$scope.results.forEach(function(result){result["abstract"]=$sce.trustAsHtml(UI.un_highlight(result["abstract"])),result.abstract_synopsis=$sce.trustAsHtml(UI.un_highlight(result.abstract_synopsis)),result.title=$sce.trustAsHtml(UI.un_highlight(result.title))})},highlight=function(){un_highlight(),$scope.results.forEach(function(result){result["abstract"]=$sce.trustAsHtml(UI.highlight(result["abstract"],keywords,$scope.selected_highlight_color.rgb)),result.abstract_synopsis=$sce.trustAsHtml(UI.highlight(result.abstract_synopsis,keywords,$scope.selected_highlight_color.rgb)),result.title=$sce.trustAsHtml(UI.highlight(result.title,keywords,$scope.selected_highlight_color.rgb))})},init_results=function(){$scope.results.forEach(function(result){result.bookmarked=!1,result["abstract"]=$sce.trustAsHtml(String(result["abstract"]).replace(/<[^>]+>/gm,"")),result.title=$sce.trustAsHtml(String(result.title).replace(/<[^>]+>/gm,"")),result.trusted_url=$sce.trustAsResourceUrl(result.url);var synopsis=String(result["abstract"]).length>600?String(result["abstract"]).substring(0,600)+"...":String(result["abstract"]);result.abstract_synopsis=$sce.trustAsHtml(synopsis),result.full_length_abstract=String(result["abstract"]).length==String(result.abstract_synopsis).length})},reset_variables=function(){$scope.iteration=1,$scope.bookmark_history_showing=!1,$scope.bookmark_history=[],$scope.results=[],$scope.keywords={}},is_exploratory=function(){var params={query_time:Math.round(((new Date).getTime()-first_iteration_started.getTime())/1e3),reading_time:Math.round(_.sum($scope.results,function(result){return result.reading_time||0})),clicked_count:_.where($scope.results,{clicked:!0}).length,seen_count:_.where($scope.results,{seen:!0}).length,query_length:$scope.search_heading.split(" ").length};return console.log(params),Classifier.is_exploratory(params)};$scope.$watch("chosen_highlight_color_index",function(newVal,oldVal){$scope.selected_highlight_color=$scope.highlight_colors[parseInt(newVal)],highlight()}),$rootScope.settings.search_query&&($scope.search_keyword=$rootScope.settings.search_query,$scope.search())}]),SearchApp.controller("SettingsController",function($scope,$rootScope,Api){$scope.setup=function(){Api.setup({participant_id:$rootScope.settings.participant_id,exploration_rate:$rootScope.settings.exploration_rate,task_type:$rootScope.settings.task_type}).success(function(){$scope.setup_saved=!0})}});