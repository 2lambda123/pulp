MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],processEscapes:!0}}),MathJax.Hub.Configured();var SearchApp=angular.module("SearchApp",["ngRoute","angular-bootstrap-select","angular-inview","ui.bootstrap"]);SearchApp.config(function($routeProvider){$routeProvider.when("/",{controller:"SearchController",templateUrl:"static/js/app/views/search.html"}).when("/settings",{controller:"SettingsController",templateUrl:"static/js/app/views/settings.html"}).when("/topic/:id",{controller:"TopicController",templateUrl:"static/js/app/views/topic.html"}).otherwise({redirectTo:"/"})}),SearchApp.run(function($rootScope){$rootScope.settings={participant_id:"",task_type:0,exploration_rate:0,query_time:15,study_type:1}}),SearchApp.filter("strip_tags",function(){return function(text){return String(text).replace(/<[^>]+>/gm,"")}}),SearchApp.filter("html",function($sce){return function(input){return $sce.trustAsHtml(input)}}),SearchApp.filter("synopsis",function(){return function(text){return String(text).length>300?String(text).substring(0,300)+"...":String(text)}});var UI=function(){var highlight_colors=[{name:"Green",rgb:"74,201,112"},{name:"Orange",rgb:"233,137,49"},{name:"Red",rgb:"235,64,59"},{name:"Turquoise",rgb:"42,176,197"},{name:"Blue",rgb:"34,127,176"}],back_to_top=function(){return $("html, body").scrollTop(0),!1},search_state=function(callback){$(".mean-bar").fadeOut(300),$(".bookmark-history-display").hide(),$("#search-results").fadeOut(300,function(){$("#search-form-container").slideDown(),$("#search-form-container input[type='text']").focus(),callback()})},end_search_state=function(){$("#search-form-container").slideUp(),back_to_top()},loading_state=function(callback){$(".layer").fadeIn(300),$("body").css("cursor","wait"),$("#search-results").fadeOut(300,function(){callback()})},end_loading_state=function(){$(".bookmark-history-display").hide(),$(".layer").fadeOut(300),$("body").css("cursor","default"),$("#search-results").fadeIn(300)},display_mean_and_variance=function(){$(".mean-bar").fadeIn(300),$.each($(".mean-bar .progress-bar"),function(i,el){width=parseFloat($(el).attr("data-mean"))/(parseFloat($(el).attr("data-mean"))+parseFloat(parseFloat($(el).attr("data-variance")))),anim={width:100*width+"%"},$(el).animate(anim,2500,"easeOutCubic"),$(el).parent().tooltip({title:Math.round(100*width)+"% based on previous selections, "+Math.round(100*(1-width))+"% variation"})})},un_highlight=function(text){return String(text).replace(/<[^>]+>/gm,"")},highlight=function(text,keywords,color){for(var content_words=String(text).split(" "),i=0;i<content_words.length;i++)keywords[content_words[i].toLowerCase()]&&(weight=keywords[content_words[i].toLowerCase()],description="",description=weight<.3?"Light weighted keyword":weight>=.3&&weight<.7?"Medium weighted keyword":"Heavy weighted keyword",content_words[i]="<span class='word-weight animated bounceIn' data-toggle='tooltip' data-placement='top' title='"+description+"' style='background-color: rgba("+color+","+weight+"); border-bottom: 1px solid rgb("+color+")'>"+content_words[i]+"</span>");return content_words.join(" ")};return{search_state:search_state,end_search_state:end_search_state,loading_state:loading_state,end_loading_state:end_loading_state,highlight:highlight,un_highlight:un_highlight,highlight_colors:highlight_colors,back_to_top:back_to_top,display_mean_and_variance:display_mean_and_variance}}();$(document).on("ready",function(){UI.search_state(function(){}),$("#back-to-top").on("click",function(){UI.back_to_top()}),$(".bookmark-info").live("mouseenter",function(){$(this).stop().animate({bottom:15},300)}),$(".bookmark-info").live("mouseleave",function(){$(this).stop().animate({bottom:0},300,"easeOutCubic")}),$(".bookmark-history-display-trigger").live("click",function(e){e.preventDefault(),$(".history-articles .bookmark").popover({trigger:"manual",html:!0}).on("mouseenter",function(){var _this=this;$(this).popover("show"),$(".popover").on("mouseleave",function(){$(_this).popover("hide")})}).on("mouseleave",function(){var _this=this;$(".popover:hover").length||$(_this).popover("hide"),setTimeout(function(){},100)})}),$("#article-count").selectpicker(),$("#highlight-color").selectpicker(),$("#back-to-top").removeAttr("disabled"),$("#explain-search-results-modal").draggable(),$(".color-palet-divider").tooltip()}),$(document).on("scroll",function(){var scrollAmount=$(window).scrollTop(),documentHeight=$(document).height(),scrollPercent=scrollAmount/documentHeight*100;scrollPercent>0?$("#back-to-top").animate({bottom:0},400):$("#back-to-top").clearQueue().animate({bottom:-45},400)}),SearchApp.directive("exploitation",function(){return{link:function(scope,elem,attrs){var width=scope.result.mean/(scope.result.mean+scope.result.variance)*100;$(elem).css("width",width+"%")}}}),SearchApp.directive("keywordChart",function(){return{scope:{data:"=ngModel"},link:function(scope,elem,attrs){var data={labels:scope.data.labels,datasets:[{fillColor:"rgba(0,151,207,0.2)",strokeColor:"rgba(0,151,207,1)",pointColor:"rgba(0,151,207,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(0,151,207,1)",data:scope.data.values}]};new Chart($(elem)[0].getContext("2d")).Radar(data,{scaleOverride:!0,scaleSteps:10,scaleStepWidth:10,scaleStartValue:0})}}}),SearchApp.directive("mathjaxBind",function(){return{restrict:"A",controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.$watch($attrs.mathjaxBind,function(texExpression){$element.html(texExpression),MathJax.Hub.Queue(["Typeset",MathJax.Hub,$element[0]])})}]}}),SearchApp.directive("result",function(){return{link:function(scope,elem,attrs){var header_height=205,items_on_screen=7,result_height=($(window).height()-header_height)/items_on_screen;$(elem).css("height",result_height+"px"),$(window).on("resize",function(){var result_height=($(window).height()-header_height)/items_on_screen;$(elem).css("height",result_height+"px")})}}}),SearchApp.directive("topicsDiagram",function(){var show_tooltip=function(title,event){var $tooltip=$("#topic-tooltip");$tooltip.html(title),$tooltip.css({left:event.clientX+10+"px",top:event.clientY+10+"px"}),$tooltip.show()},hide_tooltip=function(){var $tooltip=$("#topic-tooltip");$tooltip.hide()},create_path=function(raphael,data,options){var points=[],y=10;data.values.forEach(function(d){points.push({x:200*d.weight,y:y}),y+=20});var pointsToStr=_.map(points,function(point){return point.x+","+point.y}).join(" "),path=raphael.path("M0,10R "+pointsToStr+" 0,"+20*points.length);return path.data("topic",{id:data.id,title:data.title}),path.attr({stroke:"rgb("+options.background_RGB+")","stroke-width":2,fill:"rgba("+options.background_RGB+",.5)"}),path.mouseover(function(){path.attr("stroke-width",3),path.attr("fill","rgba("+options.background_RGB+",.7)"),path.attr("cursor","pointer")}),path.mousemove(function(event){show_tooltip(options.title,event)}),path.mouseout(function(){hide_tooltip(),path.attr("stroke-width",2),path.attr("fill","rgba("+options.background_RGB+",.5)"),path.attr("cursor","default")}),path.click(function(){options.topic_on_click(path.data("topic"))}),options.draw_points&&_.times(20,function(n){var point=raphael.circle(points[n].x,points[n].y,4).attr({stroke:"rgb("+options.background_RGB+")","stroke-width":2,fill:"white"});point.data("article",data.values[n]),point.click(function(){options.article_on_click(point.data("article"))}),point.mouseover(function(){point.animate({r:6},200);var pointDim=point.getBBox(),indicator=raphael.path("M0,"+pointDim.cy+"L300,"+pointDim.cy).attr({stroke:"rgba(255,255,255,.7)"});point.data("indicator",indicator),point.toFront()}),point.mousemove(function(event){show_tooltip(point.data("article").title,event)}),point.mouseout(function(){point.animate({r:4},200),point.data("indicator").remove(),hide_tooltip()})}),path},init_diagram=function(raphael,data,options){var colors=["253,180,92","70,191,189"];data.sort(function(a,b){var sumA=_.sum(a.values),sumB=_.sum(b.values);return sumB-sumA}),data.forEach(function(topic,n){points=n==data.length-1?!0:!1,create_path(raphael,topic,{title:topic.title,background_RGB:colors[n],draw_points:points,topic_on_click:options.topic_on_click,article_on_click:options.article_on_click})})};return{scope:{data:"=ngModel",topic_on_click:"=topicOnClick",article_on_click:"=articleOnClick"},link:function(scope,elem,attrs){var raphael=Raphael(elem[0],300,2e3);scope.$watch("data",function(topics){topics&&init_diagram(raphael,topics,{topic_on_click:scope.topic_on_click,article_on_click:scope.article_on_click})})}}}),SearchApp.service("Api",function($http){function parseIterationData(options){return{selected:_.chain(options.results).where({bookmarked:!0}).map(function(bookmark){return bookmark.id}).value(),participant_id:options.participant_id,clicked:_.chain(options.results).where({clicked:!0}).map(function(clicked){return{id:clicked.id,reading_started:clicked.reading_started.getTime()/1e3,reading_ended:clicked.reading_ended.getTime()/1e3}}).value(),seen:_.chain(options.results).where({seen:!0}).map(function(seen){return seen.id}).value()}}this.next=function(options){var params=parseIterationData(options);return(0==options.exploratory||1==options.exploratory)&&(params.exploratory=options.exploratory),$http.post("/next",params)},this.search=function(options){return $http.get("/query",{params:{q:options.keyword,"article-count":options.count,participant_id:options.participant_id}})},this.setup=function(options){return $http.get("/setup",{params:{participant_id:options.participant_id,task_type:options.task_type,exploration_rate:options.exploration_rate,experiment_id:options.study_type}})},this.end=function(options){var params=parseIterationData(options);return $http.post("/end",params)}}),SearchApp.service("Classifier",function(){this.is_exploratory=function(options){{var query_length=options.query_length,reading_time=options.reading_time,cumulative_clicks=options.clicks_count;options.seen_count,options.query_duration}return Exploratory=!0,5>=query_length?131>=reading_time?0>=cumulative_clicks?Exploratory=!0:cumulative_clicks>0&&(Exploratory=!1):reading_time>131&&(3>=query_length?Exploratory=!0:query_length>3&&(2>=cumulative_clicks?Exploratory=!0:cumulative_clicks>2&&(Exploratory=!1))):query_length>5&&(Exploratory=!1),Exploratory}}),SearchApp.service("Utils",function(){this.keywordsToChartData=function(keywords){var labels=_.map(keywords,function(keyword){return keyword.content}),values=_.map(keywords,function(keyword){return Math.round(100*keyword.weight)});return{labels:labels,values:values}}}),SearchApp.controller("SearchController",["$scope","$rootScope","$sce","$location","$interval","$anchorScroll","Api","Classifier",function($scope,$rootScope,$sce,$location,$interval,$anchorScroll,Api,Classifier){$rootScope.settings={participant_id:1},$scope.chosen_highlight_color_index=0,$scope.result_count=20,$scope.bookmark_history=[],$scope.results=[],$scope.highlight_colors=UI.highlight_colors,$scope.selected_highlight_color=UI.highlight_colors[0],$scope.iteration=1;var first_iteration_started=null,keywords={};$scope.search=function(){reset_variables(),$scope.searching=!0,$scope.loading=!0,Api.search({keyword:$scope.search_keyword,count:parseInt($scope.result_count),participant_id:$rootScope.settings.participant_id}).success(function(response){$scope.results=response,$scope.search_heading=$scope.search_keyword,$scope.loading=!1,init_results(),first_iteration_started=new Date}).error(function(){$scope.search_heading=$scope.search_keyword,$scope.loading=!1,$scope.results=[]})},$scope.toggle_bookmark_history=function(){$scope.bookmark_history_showing=!$scope.bookmark_history_showing},$scope.article_in_view=function(result){result.seen=!0},$scope.touch_article=function(article){article.clicked=!0,article.reading_started=new Date,$scope.viewed_article=article},$scope.close_article_view=function(){var now=new Date,start=$scope.viewed_article.reading_started,diff=(now.getTime()-start.getTime())/1e3;$scope.viewed_article.reading_ended=now,$scope.viewed_article.reading_time=diff,$scope.viewed_article=null},$scope.toggle_bookmark=function(result){result.bookmarked=!result.bookmarked},$scope.diagram_topic_on_click=function(){window.open("#/topic/1")},$scope.diagram_article_on_click=function(article){},$scope.next=function(){var options={results:$scope.results,participant_id:$rootScope.settings.participant_id};1==$scope.iteration&&(options.exploratory=is_exploratory()?1:0),UI.back_to_top(),$scope.bookmark_history_showing=!1;var history_obj={iteration:$scope.iteration,articles:_.where($scope.results,{bookmarked:!0})};0!=history_obj.articles.length&&$scope.bookmark_history.push(history_obj),$scope.loading=!0,Api.next(options).success(function(response){$scope.results=response.articles,keywords=response.keywords,init_results(),$scope.iteration++,$scope.search_heading=$scope.search_keyword,$scope.highlight_keywords&&highlight(),$scope.loading=!1}).error(function(){$scope.results=[],$scope.loading=!1})},$scope.back_to_top=function(){UI.back_to_top()},$scope.next_is_disabled=function(){return $scope.iteration>1||_.where($scope.results,{bookmarked:!0}).length>0?!1:!0},$scope.end=function(){var options={results:$scope.results,participant_id:$rootScope.settings.participant_id};Api.end(options).success(function(){$scope.searching=!1})},$scope.toggle_highlight=function(){$scope.highlight_keywords=!$scope.highlight_keywords,$scope.highlight_keywords?highlight():un_highlight()},$scope.show_full_abstract=function(result){result.abstract_synopsis=result["abstract"],result.full_length_abstract=!0},$scope.bookmarked_results=function(result){return 1==result.bookmarked},$scope.toggle_plain_abstract=function(result){result.show_plain_abstract=!result.show_plain_abstract};var un_highlight=function(){$scope.results.forEach(function(result){result["abstract"]=$sce.trustAsHtml(UI.un_highlight(result["abstract"])),result.abstract_synopsis=$sce.trustAsHtml(UI.un_highlight(result.abstract_synopsis)),result.title=$sce.trustAsHtml(UI.un_highlight(result.title))})},highlight=function(){un_highlight(),$scope.results.forEach(function(result){result["abstract"]=$sce.trustAsHtml(UI.highlight(result["abstract"],keywords,$scope.selected_highlight_color.rgb)),result.abstract_synopsis=$sce.trustAsHtml(UI.highlight(result.abstract_synopsis,keywords,$scope.selected_highlight_color.rgb)),result.title=$sce.trustAsHtml(UI.highlight(result.title,keywords,$scope.selected_highlight_color.rgb))})},init_results=function(articles){$scope.topics=[{id:1,title:"Java",values:[]},{id:2,title:"Programming",values:[]}],$scope.results.forEach(function(result){result.bookmarked=!1,result.plain_abstract=$sce.trustAsHtml(result["abstract"]),result.title=$sce.trustAsHtml(String(result.title).replace(/<[^>]+>/gm,"")),result.author=$sce.trustAsHtml(result.author),result.trusted_url=$sce.trustAsResourceUrl(result.url),$scope.topics[0].values.push({title:String(result.title).replace(/<[^>]+>/gm,""),id:result.id,weight:_.random(.2,1)}),$scope.topics[1].values.push({title:String(result.title).replace(/<[^>]+>/gm,""),id:result.id,weight:_.random(.2,.5)})}),_.times(80,function(){$scope.topics[0].values.push({title:"Lorem ipsum dolor sit amet",id:0,weight:_.random(.2,1)})}),_.times(80,function(){$scope.topics[1].values.push({title:"Lorem ipsum dolor sit amet",id:0,weight:_.random(.2,.5)})})},reset_variables=function(){$scope.iteration=1,$scope.bookmark_history_showing=!1,$scope.bookmark_history=[],$scope.results=[],$scope.keywords={}},is_exploratory=function(){var params={query_time:Math.round(((new Date).getTime()-first_iteration_started.getTime())/1e3),reading_time:Math.round(_.sum($scope.results,function(result){return result.reading_time||0})),clicked_count:_.where($scope.results,{clicked:!0}).length,seen_count:_.where($scope.results,{seen:!0}).length,query_length:$scope.search_heading.split(" ").length};return Classifier.is_exploratory(params)};$scope.$watch("chosen_highlight_color_index",function(newVal,oldVal){$scope.selected_highlight_color=$scope.highlight_colors[parseInt(newVal)],highlight()}),$rootScope.settings.search_query&&($scope.search_keyword=$rootScope.settings.search_query,$scope.search())}]),SearchApp.controller("SettingsController",function($scope,$rootScope,Api){$scope.setup=function(){Api.setup({participant_id:$rootScope.settings.participant_id,exploration_rate:$rootScope.settings.exploration_rate,task_type:$rootScope.settings.task_type,study_type:$rootScope.settings.study_type}).success(function(){$scope.setup_saved=!0})}}),SearchApp.controller("TopicController",function($scope,$routeParams,$location,$sce,Utils){function init_articles(){$scope.related_articles.forEach(function(article){article["abstract"]=$sce.trustAsHtml(String(article["abstract"]).replace(/<[^>]+>/gm,"")),article.title=$sce.trustAsHtml(String(article.title).replace(/<[^>]+>/gm,""));var synopsis=String(article["abstract"]).length>300?String(article["abstract"]).substring(0,300)+"...":String(article["abstract"]);article.abstract_synopsis=$sce.trustAsHtml(synopsis),article.full_length_abstract=String(article["abstract"]).length==String(article.abstract_synopsis).length})}$scope.related_articles=[],$scope.related_keywords=[];for(var i=0;10>i;i++)$scope.related_articles.push({title:"Lorem ipsum dolor sit amet","abstract":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean euismod, massa ullamcorper pellentesque ultrices, nunc mauris bibendum tortor, ac ultrices urna arcu quis lectus. Quisque ut congue mi, nec dapibus nisl. Pellentesque eu risus sed velit ullamcorper sagittis. Proin posuere congue eros, in tincidunt velit dictum at. Donec posuere sodales tellus, et fringilla lectus scelerisque id. Etiam in feugiat nibh, sit amet sollicitudin erat. Morbi eget velit ac velit sodales aliquam. Suspendisse tempor nisi nec ex consequat cursus.",author:"Lorem ipsum, dolor sit",venue:"arXiv",url:"http://cs.helsinki.fi"}),$scope.related_keywords.push({weight:Math.random(),content:"Lorem ipsum"});$scope.related_keywords=Utils.keywordsToChartData($scope.related_keywords),$scope.back=function(){$location.path("/")},$scope.show_full_abstract=function(article){article.abstract_synopsis=article["abstract"],article.full_length_abstract=!0},init_articles()});